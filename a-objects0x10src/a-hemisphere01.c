/*3rd person flying hemisphereera*/#include "ext.h"#include "ext_common.h"#include <math.h>#ifndef M_PI#define M_PI		3.14159265358979323846f	// matches value in gcc v2 math.h#endiftypedef struct	{	t_object 	        c_ob;				void 		        *c_out;		// outlet hemisphere lookat				float	w,h,in[2], move[2];	float	pos[3];	t_atom				out[3];} hemisphere;void *hemisphere_new (Symbol *msg, short argc, Atom *argv);void hemisphere_bang (hemisphere *x);void hemisphere_list (hemisphere *x, Symbol *msg, short argc, Atom *argv);void hemisphere_move (hemisphere *x, Symbol *msg, short argc, Atom *argv);void hemisphere_hv (hemisphere *x, Symbol *msg, short argc, Atom *argv);void hemisphere_assist(hemisphere *x, void *b, long m, long a, char *s);void *hemisphere_class;void *hemisphere_new (Symbol *msg, short argc, Atom *argv) //input the args {	 hemisphere *x;	 int i,j;	 float temp[3];	 	 x=(hemisphere *)newobject(hemisphere_class);	 x->c_out=listout(x);// eval'd 3d pos	 	//init	x->w=128.;	x->h=128.;		x->in[0]=0.;		x->in[1]=0.;		x->move[0]=0.;		x->move[1]=0.;		x->pos[0]=0.;		x->pos[1]=0.;		x->pos[2]=0.;				if (argc) { // set w & h		if(argv->a_type == A_FLOAT) {					x->w = (float)argv->a_w.w_float;						argv++;		} else if(argv->a_type == A_LONG) {					x->w = (float)argv->a_w.w_long;						argv++;		}		if(argv->a_type == A_FLOAT) {					x->h = (float)argv->a_w.w_float;						argv++;		} else if(argv->a_type == A_LONG) {					x->h = (float)argv->a_w.w_long;						argv++;		}	}			 return(x);	}void hemisphere_list (hemisphere *x, Symbol *msg, short argc, Atom *argv){	float temp[3];	short j;    float d, a;	float w, h, in[2], v[3];		if(argc) {		for(j=0;j<2;j++) {		if(argv->a_type == A_FLOAT) {			temp[j] = (float)argv->a_w.w_float;				argv++;		} else if(argv->a_type == A_LONG) {			temp[j] = (float)argv->a_w.w_long;				argv++;		}	}	in[0] = x->in[0]=temp[0];	in[1] = x->in[1]=temp[1];	w=x->w; h=x->h;     /* project x,y onto a hemi-sphere centered within width, height */    v[0] = (2.0*in[0] - w) / w;    v[1] = (h - 2.0*in[1]) / h;    d = sqrt(v[0]*v[0] + v[1]*v[1]);    v[2] = cos((M_PI/2.0) * ((d < 1.0) ? d : 1.0));    a = 1.0 / sqrt(v[0]*v[0] + v[1]*v[1] + v[2]*v[2]);    v[0] *= a;    v[1] *= a;    v[2] *= a;	x->pos[0]=v[0];	x->pos[1]=v[1];	x->pos[2]=v[2];	}}void hemisphere_bang (hemisphere *x){	short i;	t_atom * o;			o = x->out;	for(i=0;i<3;i++) {		SETFLOAT(o+i, x->pos[i]);	}	outlet_list(x->c_out, 0L, 3, o);}void hemisphere_move (hemisphere *x, Symbol *msg, short argc, Atom *argv){	float temp[3];	short j;	for(j=0;j<2;j++) {		if(argv->a_type == A_FLOAT) {			temp[j] = (float)argv->a_w.w_float;				argv++;		} else if(argv->a_type == A_LONG) {			temp[j] = (float)argv->a_w.w_long;				argv++;		}	}	x->move[0]=temp[0];	x->move[1]=temp[1];}void hemisphere_hv (hemisphere *x, Symbol *msg, short argc, Atom *argv){	float temp[3];	short j;	for(j=0;j<2;j++) {		if(argv->a_type == A_FLOAT) {			temp[j] = (float)argv->a_w.w_float;				argv++;		} else if(argv->a_type == A_LONG) {			temp[j] = (float)argv->a_w.w_long;				argv++;		}	}	x->w=temp[0];	x->h=temp[1];}void main(void){ long int tick = gettime(); setup((t_messlist**)&hemisphere_class,(method)hemisphere_new,0L,(short)sizeof(hemisphere),0L, A_GIMME,0); addbang((method)hemisphere_bang); addmess((method)hemisphere_move,"move",A_GIMME, 0); addmess((method)hemisphere_list,"list",A_GIMME, 0); addmess((method)hemisphere_hv,"hv",A_GIMME, 0); addmess((method)hemisphere_assist,"assist", A_CANT, 0); post(__DATE__" \t \a \t  "__TIME__"\t \a \t %08xd                                                     a-hemisphere   ©   a n d r Ž s i e r   2 0 0 4   all rights reserved",tick, 0);}void hemisphere_assist(hemisphere *x, void *b, long m, long a, char *s){    if (m==1) { sprintf(s,"echo e   c  h   o"); }       else if (m==2&&a==0) { sprintf(s,"(list) lookat     e         c            h              o"); }    else if (m==2&&a==1) { sprintf(s,"(list) pos    e         c            h              o"); }    else if (m==2&&a==2) { sprintf(s,"(list) up    e         c            h              o"); }}/*----------------------------------------------------------	EOF----------------------------------------------------------*/